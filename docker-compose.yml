version: "3"
services:
  elasticsearch:
    container_name: elasticsearch
    image: elasticsearch:7.17.7
    network_mode: host
    restart: unless-stopped
    environment:
      - node.name=es01
      - cluster.name=es-docker-cluster
      - discovery.type=single-node
      - ELASTIC_PASSWORD=elastic
      - xpack.security.enabled=true
      - "ES_JAVA_OPTS=-Xms1g -Xmx3.5g"
  redis:
    container_name: redis
    image: redis:5.0.10
    volumes:
      - /docker/redis:/data/
    network_mode: host
    restart: unless-stopped
    user: root
  dht-server-1: &dht-server
    depends_on:
      - redis
    image: zpqsunny/dht-server:latest
    build:
      context: dht-server
      dockerfile: Dockerfile
    network_mode: host
    restart: unless-stopped
    environment:
      - PORT=6881
      - REDIS_HOST=127.0.0.1
      - REDIS_PORT=6379
      - REDIS_PASSWORD=
      - REDIS_DATABASE=0
  dht-server-2:
    <<: *dht-server
    environment:
      - PORT=6882
  dht-server-3:
    <<: *dht-server
    environment:
      - PORT=6883
  mongo:
    container_name: mongo
    image: mongo:4.4.1
    volumes:
      - /docker/mongo/db:/data/db
      - /docker/mongo/backup:/backup
    command: mongod --shardsvr --replSet shareA --bind_ip 0.0.0.0 --port 27018
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=admin
    network_mode: host
    restart: unless-stopped
  dht-peer:
    depends_on:
      - redis
      - mongo
    deploy:
      mode: replicated
      replicas: 3
    image: zpqsunny/dht-peer:latest
    build:
      context: dht-server
      dockerfile: Dockerfile
    network_mode: host
    restart: unless-stopped
    volumes:
      - /metadata:/metadata
    environment:
      - MONGODB_URL=mongodb://admin:admin@127.0.0.1:27018/?authSource=admin
      - REDIS_HOST=127.0.0.1
      - REDIS_PORT=6379
      - REDIS_PASSWORD=
      - REDIS_DATABASE=0
  dht-es:
    depends_on:
      - mongo
    image: zpqsunny/dht-es:latest
    build:
      context: dht-es
      dockerfile: Dockerfile
    network_mode: host
    restart: unless-stopped
    environment:
      - MONGODB_URL=mongodb://admin:admin@127.0.0.1:27018/?authSource=admin
      - ES_HOST=http://127.0.0.1
      - ES_PORT=9200
      - ES_USERNAME=elastic
      - ES_PASSWORD=elastic